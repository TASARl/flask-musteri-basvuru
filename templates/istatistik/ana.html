{% extends "modul__base_yeni.html" %}
{% block styles %}


{% endblock %}


{% block title %}HızlıKredi | En Hızlı Taşıt Kredisi{% endblock %}



{% block content %}
<div class="card-rounded bg-light d-flex flex-wrap p-5 mb-5">
    <div class="row w-100 align-items-center">
      <div class="col-sm-12 col-md-6 col-lg-3 mb-3 mb-lg-0">
        
        <label for="" class="form-label">Başlangıç</label>
        <input class="form-control" type="month" id="start" name="start">
    </div><div class="col-sm-12 col-md-6 col-lg-3 mb-3 mb-lg-0">

        <label for="" class="form-label">Bitiş</label>
        <input  class="form-control"  type="month" id="end" name="end">
    </div><div class="col-sm-12 col-md-6 col-lg-3 mb-3 mb-lg-0">
        <label for="" class="form-label">Hazır Seçenekler</label>
        <select class="form-select" data-control="select2" id="select">
            <option value="1">Son 1 Ay</option>
            <option value="3">Son 3 Ay</option>
            <option value="6">Son 6 Ay</option>
            <option value="12">Son 1 Yıl</option>
        </select>
      </div>
      <div class="col-sm-12 col-md-6 col-lg-3 mb-3 mb-lg-0">
        <!--begin::Nav-->
        <label for="" class="form-label">Saha</label>
        <ul class="nav flex-wrap border-transparent fw-bold" style="width: 250px !important"><!-- Add inline CSS to set the width -->
            <!--begin::Nav item-->
            <li class="nav-item my-1">
                <select class="form-select" data-control="select2" id="saha_sorumlusu_secimi">
                    <option value="Tüm">Tüm Personel</option>
                </select>
            </li>
            <!--end::Nav item-->
        </ul>
        <!--end::Nav-->
      </div>
      
    </div>
  </div>

<div style="height: 300px">
    <canvas id="chart1"></canvas>
</div>
<div style="height: 100px">
    <canvas id="chart2"></canvas>
  </div>

<div id="table"></div>

{% endblock %}



{% block scripts %} 
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.4.0/dist/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-crosshair@1.2.0"></script>
<script>
$(document).ready(function() {
    isFunctionExecuted = false;
  drawCharts();
});

function drawCharts(secili_saha_sorumlusu) {
  $.getJSON("/veriler", function(data) {
    // İlk tüm şehirler bilgisini al ve selectboxa ekle
    if (!isFunctionExecuted) {
      for (var key in data) {
        var city = data[key].saha_sorumlusu;
        $('#saha_sorumlusu_secimi').append($('<option>').text(city).attr('value', city));
      }
      isFunctionExecuted = true;
    }

    // Tarihleri gruplandır
    var groupedData = {};

    for (var key in data) {
      var item = data[key];

      if (!groupedData[item.tarih]) {
        groupedData[item.tarih] = {
          tarih: item.tarih,
          net_kar: 0,
          harcama: 0,
          komisyon_geliri: 0,
          kredi_adedi:0
        };
      }

      groupedData[item.tarih].kredi_adedi += item.kredi_adedi;
      groupedData[item.tarih].net_kar += item.net_kar;
      groupedData[item.tarih].harcama += item.harcama;
      groupedData[item.tarih].komisyon_geliri += item.komisyon_geliri;
    }

    // Şehirlere göre filtreleme yap.
    var filteredData = {};
    
    if (secili_saha_sorumlusu === "Tüm" || !secili_saha_sorumlusu) {
      filteredData = groupedData;
    } else {
      for (var key in data) {
        var item = data[key];

        if (item.saha_sorumlusu === secili_saha_sorumlusu) {
          if (!filteredData[item.tarih]) {
            filteredData[item.tarih] = {
              tarih: item.tarih,
              net_kar: 0,
              harcama: 0,
              komisyon_geliri: 0,
              kredi_adedi: 0
            };
          }

          filteredData[item.tarih].kredi_adedi += item.kredi_adedi;
          filteredData[item.tarih].net_kar += item.net_kar;
          filteredData[item.tarih].harcama += item.harcama;
          filteredData[item.tarih].komisyon_geliri += item.komisyon_geliri;
        }
      }
    }
    
    // Grafiği oluştur.

    var labels = [];
    var net_kar_data = [];
    var harcama_data = [];
    var komisyon_geliri_data = [];
    var kredi_adedi_data = [];

    for (var key in filteredData) {
      var item = filteredData[key];

      labels.push(item.tarih);
      net_kar_data.push(item.net_kar);
      harcama_data.push(item.harcama);
      komisyon_geliri_data.push(item.komisyon_geliri);
      kredi_adedi_data.push(item.kredi_adedi);
    }

    var ctx1 = document.getElementById('chart1').getContext('2d');
    var chart1 = new Chart(ctx1, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Net Kar',
          data: komisyon_geliri_data,
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.5)',
          cubicInterpolationMode: 'monotone',
        }, {
          label: 'Harcama',
          data: net_kar_data,
          borderColor: 'rgb(255, 99, 132)',
          backgroundColor: 'rgba(255, 99, 132, 0.3)',
          cubicInterpolationMode: 'monotone',
          fill: true
        }, {
          label: 'Komisyon Geliri',
          data: harcama_data,
          borderColor: 'rgb(54, 162, 235)',
          backgroundColor: 'rgba(54, 162, 235, 0.3)',
          cubicInterpolationMode: 'monotone',
          fill: true,
        }]
      },
      options: {  
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                },
                crosshair: {
                    line:{
                        width:3,
                    },
                    sync: {
                        enabled: true,
                    },
                },
                tooltip: {
                    mode: 'interpolate',
                    intersect: false
                }
            },
            layout: {
                padding: {
                    left: 0,
                    right: 0
                }
            },
        }
    });

    var ctx2 = document.getElementById('chart2').getContext('2d');
    var chart2 = new Chart(ctx2, {
        type: 'line', // bar yerine line
        data: {
            labels: labels,
            datasets: [{
                label: 'Kredi Adedi',
                data: kredi_adedi_data,
                borderColor: 'rgba(255, 205, 86, 1)',
                borderWidth: 1,
                fill: true,
                cubicInterpolationMode: 'monotone',
            }]
        },
        options: {  
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                },
                crosshair: {
                    line:{
                        width:3,
                    },
                    sync: {
                        enabled: true,
                    },
                    tooltip: {
                        mode: 'interpolate',
                        intersect: false
                    }
                }
            },
            layout: {
                padding: {
                    left: 10,
                    right: 19
                }
            },
        }
    });

    // Veri tablosunu oluştur.
    $('#table').empty();
    $('#table').append('<tr><th>Tarih</th><th>Kredi Adedi</th><th>Net Kar</th><th>Harcama</th><th>Komisyon Geliri</th></tr>');

    for (var key in filteredData) {
        var item = filteredData[key];

        $('#table').append('<tr><td>' + item.tarih + '</td><td>' + item.kredi_adedi + '</td><td>' + item.net_kar + '</td><td>' + item.harcama + '</td><td>' + item.komisyon_geliri + '</td></tr>');
    }

    // Selectbox'dan seçilen şehre göre grafiği yeniden çiz.
    $('#saha_sorumlusu_secimi').on('change', function() {
        var secili_saha_sorumlusu = $(this).val();

        if (chart1 && chart2) {
            chart1.destroy();
            chart2.destroy();
        }

        drawCharts(secili_saha_sorumlusu);
    });
  });
}
</script>
        

<script>
    $(document).ready(function() {
      const startInput = $('#start');
      const endInput = $('#end');
      const select = $('#select');
  
      const currentDate = new Date();
      const currentYear = currentDate.getFullYear();
      const currentMonth = currentDate.getMonth() + 1;
      const minMonth = `${currentYear}-${(currentMonth).toString().padStart(2, '0')}`;
      startInput.attr('min', '1900-01');
      endInput.attr('min', minMonth);
  
      startInput.on('change', function() {
        const startValue = startInput.val();
        endInput.attr('min', startValue);
      });
  
      select.on('change', function() {
        const numberOfMonths = select.val();
        const startDate = new Date(currentYear, currentMonth - numberOfMonths, 1);
        const startYear = startDate.getFullYear();
        const startMonth = startDate.getMonth() + 1;
        const startMonthAsString = startMonth.toString().padStart(2, '0');
        startInput.val(`${startYear}-${startMonthAsString}`);
        endInput.val(minMonth);
      });

        startInput.on('change', handleInputChange);
        endInput.on('change', handleInputChange);
        select.on('change', handleInputChange);

        function handleInputChange() {
            const startDate = new Date(startInput.val());
            const endDate = new Date(endInput.val());

            const startYear = startDate.getFullYear();
            const startMonth = startDate.getMonth() + 1;
            const startMonthAsString = startMonth.toString().padStart(2, '0');

            const endYear = endDate.getFullYear();
            const endMonth = endDate.getMonth() + 1;
            const endMonthAsString = endMonth.toString().padStart(2, '0');

            console.log(`${startMonthAsString}-${startYear}`, `${endMonthAsString}-${endYear}`);
        }
  
      select.val("6").trigger('change');
    });
  </script>
  
{% endblock %}